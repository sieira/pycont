env:
  DOCKER_COMPOSE_VERSION: 1.24.1

before_install:
  - sudo apt-get update
  - sudo apt-get install -o Dpkg::Options::="--force-confold" --force-yes -y docker-ce
  - docker-compose --version
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin
  - docker-compose --version

jobs:
  include:
    - stage: "Testing & Linting"
      name: "Markdownlint"
      script:
        - gem install mdl
        - mdl .
    - name: "Pylint"
      script: docker-compose run pycont-test pylint --load-plugins=pylint_django pycont
    - name: "Pycodestyle"
      script: docker-compose run pycont-test pycodestyle pycont
    - name: "Pydocstyle"
      script: docker-compose run pycont-test pydocstyle pycont
    - name: "Eslint"
      script: docker-compose run pycont-ui npm run lint
    - name: "Unit testing"
      before_script:
        - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
        - chmod +x ./cc-test-reporter
        - ./cc-test-reporter before-build
        - echo UID=$UID > .env
        - echo GID=$GID >> .env
      script:
        - docker-compose up -d mariadb-test
        - docker-compose run pycont-test sh -c "./wait_for_mysql.py && coverage run ./manage.py test tests --noinput --traceback || true; coverage xml"
        - sed -i 's/\/usr\/src\/app\//core\//g' core/cobertura.xml
        - docker-compose run pycont-ui npm run test-ci
      after_script:
        - ./cc-test-reporter format-coverage -t cobertura -o coverage-core.json core/cobertura.xml
        - ./cc-test-reporter format-coverage --prefix /usr/src/app/ --add-prefix ui/ -i lcov -o coverage-ui.json ui/lcov.info
        - ./cc-test-reporter sum-coverage --output - --parts 2 coverage.json
        - ./cc-test-reporter upload-coverage -i coverage.json
